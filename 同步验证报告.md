# DWD 同步脚本迁移到 dbt 记录与验证报告

- 项目目录：`d:\project\bq_dbt\bq_dbt`
- 报告时间：2026-02-06（UTC）
- 数据集：`julang-dev-database.UserProfile`

## 1. 目标与范围

将原 Python 同步脚本 `dwd_sync_app.py` 的 6 步 DWD 同步逻辑迁移为 dbt 模型，并完成：

1. 模型分层（`staging / intermediate / marts`）
2. 增量策略落地（BigQuery `merge`）
3. 唯一性与完整性测试
4. BigQuery 落库结果核验

---

## 2. 原脚本逻辑梳理（数据映射）

原脚本 `dwd_sync_app.py` 同步步骤：

1. `dwd_customer_email_phone_map`
- 来源：`ods_shopify_customers`
- 规则：按 `(email, phone)` 去重，生成 `customer_id`

2. `dwd_customer_id`
- 来源：`dwd_customer_email_phone_map`
- 规则：补齐 customer 主键表，`merge_record` 初始为空 JSON

3. `dwd_customer_shopify_map`
- 来源：`ods_shopify_customers` + `dwd_customer_email_phone_map`
- 规则：通过 email/phone 映射 `customer_id <-> shopify_id`

4. `dwd_customer`
- 来源：`dwd_customer_email_phone_map` + `dwd_customer_shopify_map` + `ods_shopify_customers`
- 规则：聚合客户维度信息（currency/address/name/tags 等）

5. `dwd_orders`
- 来源：`ods_shopify_orders` + `dwd_customer_shopify_map`
- 规则：订单明细落表；无法映射客户时 `customer_id='unknown'`

6. `dwd_customers_journey`
- 来源：`ods_shopify_customer_journey_summary` + `dwd_orders`
- 规则：解析 journey JSON，多种 key 兼容；过滤 `unknown`

---

## 3. dbt 实施结果

## 3.1 结构与配置

- 修改：`dbt_project.yml`
- 新增：
  - `models/staging`
  - `models/intermediate`
  - `models/marts`
  - `macros`
  - `tests`

关键配置：

- `vars.safety_window_hours: 24`
- `marts` 默认：`materialized=incremental`、`incremental_strategy=merge`

## 3.2 新增/修改文件清单

### 配置与宏

- `dbt_project.yml`
- `macros/incremental_updated_filter.sql`
- `macros/dedupe_email_phone_map.sql`
- `macros/dedupe_customer_id.sql`
- `macros/dedupe_customer_shopify_map.sql`

### Sources 与 Staging

- `models/staging/sources.yml`
- `models/staging/stg_ods_shopify_customers.sql`
- `models/staging/stg_ods_shopify_orders.sql`
- `models/staging/stg_ods_shopify_customer_journey_summary.sql`

### Intermediate

- `models/intermediate/int_customer_email_phone_pairs.sql`
- `models/intermediate/int_customer_shopify_links.sql`
- `models/intermediate/int_orders_latest.sql`
- `models/intermediate/int_customer_journey_latest.sql`

### Marts（6 张 DWD）

- `models/marts/dwd_customer_email_phone_map.sql`
- `models/marts/dwd_customer_id.sql`
- `models/marts/dwd_customer_shopify_map.sql`
- `models/marts/dwd_customer.sql`
- `models/marts/dwd_orders.sql`
- `models/marts/dwd_customers_journey.sql`

### 测试

- `models/marts/schema.yml`
- `tests/test_dwd_customer_email_phone_map_unique_email_phone.sql`
- `tests/test_dwd_customer_shopify_map_unique_combo.sql`

---

## 4. 关键约束与确认项（按你的要求）

1. 保持原逻辑：`dwd_orders.customer_id='unknown'` 保留
2. `dwd_customer_email_phone_map` 唯一键：`(email, phone)`
3. 目录结构：按 `staging/intermediate/marts`

---

## 5. 测试执行过程与修复记录

## 5.1 语法与依赖

- 命令：`conda run -n data dbt parse`
- 结果：通过

## 5.2 构建与测试

- 命令：`conda run -n data dbt build --select +marts`
- 最终结果：`PASS=30 WARN=0 ERROR=0 SKIP=0`

## 5.3 中途问题与修复

1. `BOM` 导致 BigQuery SQL 非法字符
- 现象：`Illegal input character "\357"`
- 修复：统一移除新增文件 BOM，改为无 BOM UTF-8

2. Merge 多匹配错误
- 现象：`UPDATE/MERGE must match at most one source row for each target row`
- 影响表：
  - `dwd_customer_email_phone_map`
  - `dwd_customer_id`
  - `dwd_customer_shopify_map`
- 修复：
  - 源端聚合去重（按业务唯一键）
  - 为历史目标表增加 `pre_hook` 去重宏（增量前清理历史重复键）

3. BigQuery 不支持 `delete+insert` 增量策略
- 现象：`Invalid incremental strategy provided: delete+insert`
- 修复：恢复 `merge`，并保留 `pre_hook` 去重方案

---

## 6. BigQuery 实库验证结果

## 6.1 行数与最新更新时间（UTC）

| table_name | row_count | max_updated_at_utc |
|---|---:|---|
| dwd_customer_email_phone_map | 7414 | 2026-02-06 02:13:26 |
| dwd_customer_id | 7633 | 2026-02-06 02:18:25 |
| dwd_customer_shopify_map | 7633 | 2026-02-06 02:17:09 |
| dwd_customer | 7633 | 2026-02-06 02:18:45 |
| dwd_orders | 7413 | 2026-02-06 02:18:45 |
| dwd_customers_journey | 1605 | 2026-02-06 02:19:06 |

结论：全部目标表均已同步到本次执行窗口。

## 6.2 唯一性检查（重复组数）

| 检查项 | duplicate_rows |
|---|---:|
| dwd_customer_email_phone_map(email,phone) | 0 |
| dwd_customer_id(customer_id) | 0 |
| dwd_customer_shopify_map(customer_id,shopify_id) | 0 |
| dwd_customer(customer_id) | 0 |
| dwd_orders(order_id) | 0 |
| dwd_customers_journey(shopify_order_id) | 0 |

结论：唯一性符合要求。

## 6.3 关联完整性检查

| 检查项 | issue_count |
|---|---:|
| missing_in_customer_id_from_email_phone_map | 0 |
| missing_in_customer_from_email_phone_map | 0 |
| journey_customer_unknown | 0 |
| orders_customer_unknown | 5351 |

说明：`orders_customer_unknown=5351` 为“保持现状”的既有业务规则结果，不视为迁移失败。

## 6.4 业务覆盖口径

1. `dwd_orders` 中 `unknown` 占比
- `total_orders=7413`
- `unknown_orders=5351`
- `unknown_pct=72.18%`

2. `journey` 对可识别订单覆盖
- `eligible_order_cnt=2062`
- `covered_cnt=1605`
- `missing_cnt=457`
- `coverage_pct=77.84%`

3. `email/phone` 映射覆盖
- ODS 有效去重对：`7413`
- DWD 去重对：`7414`
- ODS 中缺失到 DWD：`0`

4. `shopify_id` 映射现状（订单侧）
- 订单侧 distinct `shopify_id`：`6554`
- 映射表 distinct `shopify_id`：`7413`
- 订单侧未映射 `shopify_id`：`4689`

---

## 7. 总结

1. dbt 迁移已完成，结构、逻辑、增量策略均已落地。
2. 全链路构建和测试通过（`PASS=30`）。
3. BigQuery 实库验证通过：
- 数据已同步
- 主键/组合键唯一性满足要求
- 关键链路完整性满足要求
4. 当前主要业务现状是 `dwd_orders` 中 `unknown` 占比高（72.18%），与原规则一致；若要优化，需单独推进映射策略提升。

---

## 8. 可选下一步

1. 增加 `unknown` 根因分析模型（按店铺/时间/字段缺失类型拆解）
2. 增加调度级监控（每次 `dbt build` 后自动产出质量报表）
3. 将关键核对 SQL 固化为 `data tests` 或 `exposures` 文档
