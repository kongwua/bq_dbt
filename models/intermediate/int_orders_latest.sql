select
  ods.id as order_id,
  safe_cast(json_value(ods.customer, '$.id') as int64) as shopify_id,
  ods.name as order_name,
  ods.note,
  ods.tags,
  ods.email,
  ods.phone,
  ods.app_id,
  ods.refunds,
  ods.currency,
  ods.shop_url,
  ods.closed_at,
  ods.confirmed,
  ods.browser_ip,
  ods.created_at as order_created_at,
  ods.deleted_at as order_deleted_at,
  ods.line_items,
  ods.updated_at as order_updated_at,
  ods.cancelled_at as order_cancelled_at,
  ods.source_name,
  ods.total_price,
  ods.fulfillments,
  ods.landing_site,
  ods.processed_at as order_processed_at,
  ods.total_weight,
  ods.contact_email,
  ods.client_details,
  ods.discount_codes,
  ods.referring_site,
  ods.shipping_lines,
  ods.subtotal_price,
  ods.billing_address,
  ods.customer_locale,
  ods.deleted_message,
  ods.duties_included,
  ods.estimated_taxes,
  ods.total_discounts,
  ods.total_price_usd,
  ods.shipping_address,
  ods.current_total_tax,
  ods.total_outstanding,
  ods.fulfillment_status,
  ods.current_total_price,
  ods.total_discounts_set,
  ods.presentment_currency,
  ods.current_total_tax_set,
  ods.discount_applications,
  ods.payment_gateway_names,
  ods.current_subtotal_price,
  ods.total_line_items_price,
  ods.buyer_accepts_marketing,
  ods.current_total_discounts,
  ods._airbyte_extracted_at,
  ods.updated_at
from {{ ref('stg_ods_shopify_orders') }} as ods
where ods.id is not null
qualify row_number() over (
  partition by ods.id
  order by ods.updated_at desc, ods._airbyte_extracted_at desc
) = 1
